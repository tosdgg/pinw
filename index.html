<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Pachinko</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            background-image: radial-gradient(circle, #2c3e50 0%, #000000 100%);
            color: white;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* 機台外框 */
        #machine-frame {
            position: relative;
            width: 500px; /* 柏青哥通常比較窄長 */
            height: 800px;
            background: linear-gradient(45deg, #d35400, #e67e22, #d35400);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 50px rgba(255, 100, 0, 0.5), inset 0 0 20px rgba(0,0,0,0.8);
            border: 5px solid #bdc3c7;
        }

        /* 內部遊戲區 */
        #game-area {
            position: relative;
            width: 100%;
            height: 100%;
            background: url('https://img.freepik.com/free-vector/japanese-pattern-background_53876-115372.jpg?w=740&t=st=1709123456') center/cover;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 30px #000;
        }

        /* 玻璃反光效果 */
        #glass-reflection {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 40%, rgba(255,255,255,0.05) 100%);
            z-index: 20;
            pointer-events: none;
            border-radius: 10px;
        }

        /* UI 顯示 */
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 15;
            text-shadow: 0 0 5px #000;
        }
        
        h1 { margin: 0; font-size: 20px; color: #f1c40f; letter-spacing: 2px; }
        .score-box { 
            font-size: 36px; 
            font-weight: bold; 
            color: #fff; 
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.6);
            padding: 5px 20px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
            border: 1px solid #f1c40f;
        }

        #jackpot-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-weight: 900;
            color: #e74c3c;
            text-shadow: 0 0 20px #fff, 0 0 40px #f1c40f;
            opacity: 0;
            pointer-events: none;
            z-index: 30;
            transition: opacity 0.2s;
        }
        #jackpot-overlay.active { opacity: 1; animation: shake 0.5s; }

        @keyframes shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-55%, -45%) rotate(-5deg); }
            75% { transform: translate(-45%, -55%) rotate(5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }

        /* 發射按鈕提示 */
        #launch-btn {
            position: absolute;
            bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            background: radial-gradient(circle, #e74c3c, #c0392b);
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 10px red;
            cursor: pointer;
            z-index: 25;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

    <div id="machine-frame">
        <div id="ui-panel">
            <h1>PACHINKO</h1>
            <div class="score-box" id="score">0</div>
        </div>
        
        <div id="game-area"></div>
        <div id="glass-reflection"></div>
        <div id="jackpot-overlay">大当り!</div>
        
        <div id="launch-btn" onclick="launchBall()"></div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO5nwKqK0iYAzeMKhQgUHEN3FSrcMDzYxgclXwAu5dAH0Bcx_lBd9_olSw8JTT_s354u1i_rqonZwF/pub?output=csv';

        // Matter.js 模組
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Vector = Matter.Vector;

        // 初始化
        const engine = Engine.create();
        const world = engine.world;
        
        // 柏青哥的物理特性：球很輕，彈性高，重力正常
        engine.gravity.y = 1.2; 

        // 畫布尺寸配合 CSS
        const width = 500;
        const height = 800;

        const render = Render.create({
            element: document.getElementById('game-area'),
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: 'transparent' // 讓 CSS 背景圖透出來
            }
        });

        // 邊界 (隱形牆壁)
        const walls = [
            Bodies.rectangle(width/2, height + 50, width, 100, { isStatic: true, label: 'floor' }), // 底部死區
            Bodies.rectangle(-10, height/2, 20, height, { isStatic: true }),
            Bodies.rectangle(width + 10, height/2, 20, height, { isStatic: true })
        ];
        Composite.add(world, walls);

        // 變數
        let score = 0;
        let balls = 0;

        // 讀取 CSV
        function loadLevel() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    const elements = [];
                    results.data.forEach(row => {
                        if (row.x && row.y) {
                            const size = row.size || 6; // 預設很小的釘子
                            
                            if (size >= 30) {
                                // --- 入賞口 (Win Pocket) ---
                                // 建立一個「感測器」而不是實體，這樣球可以穿過去
                                const pocket = Bodies.circle(row.x, row.y, size/2, {
                                    isStatic: true,
                                    isSensor: true, // 設為感測器，球不會撞上反彈，而是穿過
                                    label: 'pocket',
                                    render: {
                                        fillStyle: 'rgba(231, 76, 60, 0.8)', // 紅色透明
                                        strokeStyle: '#f1c40f',
                                        lineWidth: 4
                                    }
                                });
                                // 裝飾用的外圈 (視覺)
                                const ring = Bodies.circle(row.x, row.y, size/2 + 5, {
                                    isStatic: true,
                                    isSensor: true,
                                    render: { fillStyle: 'transparent', strokeStyle: '#fff', lineWidth: 2 }
                                });
                                elements.push(pocket, ring);

                            } else {
                                // --- 普通釘子 (Nail) ---
                                const nail = Bodies.circle(row.x, row.y, size/2, { // 試算表是直徑還是半徑看習慣，這裡除以2當半徑
                                    isStatic: true,
                                    label: 'nail',
                                    render: {
                                        fillStyle: '#f39c12', // 金色
                                        strokeStyle: '#f1c40f',
                                        lineWidth: 1
                                    },
                                    restitution: 0.8 // 金屬彈性
                                });
                                elements.push(nail);
                            }
                        }
                    });
                    Composite.add(world, elements);
                }
            });
        }

        // 發射彈珠
        window.launchBall = function() {
            // 柏青哥通常從上方某個通道出來，這裡模擬從左上角打入
            const startX = 40 + Math.random() * 20; 
            const startY = 0;
            
            const ball = Bodies.circle(startX, startY, 5.5, { // 11mm 標準彈珠
                restitution: 0.7,
                friction: 0.001,
                frictionAir: 0.01, // 空氣阻力小
                label: 'ball',
                render: {
                    fillStyle: '#ecf0f1', // 銀色鋼珠
                    strokeStyle: '#bdc3c7',
                    lineWidth: 1
                }
            });

            // 給予一個初始推力 (模擬彈簧發射)
            const force = 0.01 + Math.random() * 0.005;
            Body.applyForce(ball, ball.position, { x: force, y: 0.01 });

            Composite.add(world, ball);
            balls++;
        };

        // 碰撞與遊戲邏輯
        Events.on(engine, 'collisionStart', function(event) {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                
                // 檢查是否進洞 (Pocket)
                // 因為 Pocket 是 Sensor，所以會有 collisionStart 但不會有物理反彈
                const ball = bodyA.label === 'ball' ? bodyA : (bodyB.label === 'ball' ? bodyB : null);
                const pocket = bodyA.label === 'pocket' ? bodyA : (bodyB.label === 'pocket' ? bodyB : null);

                if (ball && pocket) {
                    triggerJackpot(ball);
                }
            });
        });

        // 處理球掉出邊界
        Events.on(engine, 'collisionStart', function(event) {
             event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (bodyA.label === 'floor' || bodyB.label === 'floor') {
                    const ball = bodyA.label === 'ball' ? bodyA : bodyB;
                    Composite.remove(world, ball); // 默默移除
                }
             });
        });

        function triggerJackpot(ballBody) {
            // 1. 加分
            score += 100;
            document.getElementById('score').innerText = score;

            // 2. 特效
            const overlay = document.getElementById('jackpot-overlay');
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 800);

            // 3. 移除進洞的球 (避免重複觸發)
            Composite.remove(world, ballBody);

            // 4. 獎勵：自動噴出 5 顆球 (柏青哥的出玉機制)
            let count = 0;
            const payout = setInterval(() => {
                launchBall();
                count++;
                if(count >= 5) clearInterval(payout);
            }, 200);
        }

        // 啟動
        loadLevel();
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // 按空白鍵也可以發射
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') launchBall();
        });

    </script>
</body>
</html>
