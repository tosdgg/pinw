<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真實風格帕青哥 (Pachinko)</title>
    <style>
        body {
            margin: 0;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial Black', sans-serif;
            overflow: hidden;
        }

        /* 機台外殼 */
        #pachinko-frame {
            position: relative;
            width: 520px;
            height: 850px;
            background: linear-gradient(135deg, #ff0055 0%, #ff0000 50%, #990000 100%);
            border-radius: 30px;
            border: 10px solid #dcdcdc;
            box-shadow: 0 0 80px rgba(255, 0, 0, 0.6), inset 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            padding-top: 20px;
        }

        /* 遊戲主畫面區域 */
        #game-area {
            position: relative;
            width: 480px;
            height: 700px;
            background-color: #222;
            /* CSS 繪製日式背景，防止破圖 */
            background-image: 
                radial-gradient(circle at 50% 50%, #333 10%, transparent 10%),
                radial-gradient(circle at 0% 50%, #333 10%, transparent 10%),
                radial-gradient(circle at 100% 50%, #333 10%, transparent 10%);
            background-size: 30px 30px;
            border-radius: 15px 15px 60px 15px; /* 右下角切角給發射器 */
            border: 4px solid #f1c40f;
            box-shadow: inset 0 0 50px #000;
            overflow: hidden;
        }

        /* 中央液晶螢幕 (裝飾用) */
        #lcd-screen {
            position: absolute;
            top: 250px; left: 50%;
            transform: translateX(-50%);
            width: 200px; height: 150px;
            background: #000;
            border: 4px solid #00ffff;
            box-shadow: 0 0 20px #00ffff;
            z-index: 0; /* 在釘子後面 */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 24px;
            text-align: center;
            opacity: 0.8;
        }

        /* 分數顯示 */
        #ui-score {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 40px;
            color: #f1c40f;
            text-shadow: 0 0 10px #ff0000;
            z-index: 100;
        }

        /* 手把區域 */
        #handle-area {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #555, #222);
            border-radius: 50%;
            border: 5px solid #888;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }
        #handle-area:active { transform: rotate(15deg); }
        #handle-text {
            position: absolute;
            top: 110%; left: 50%; transform: translateX(-50%);
            color: white; font-size: 12px; white-space: nowrap;
        }

        #jackpot-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 60px; color: #ff0055;
            text-shadow: 0 0 20px #fff;
            transition: transform 0.2s;
            z-index: 200;
            pointer-events: none;
        }
        #jackpot-msg.active { transform: translate(-50%, -50%) scale(1); }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

    <div id="pachinko-frame">
        <div id="ui-score">0</div>
        
        <div id="game-area">
            <div id="lcd-screen">GOGO!<br>PACHINKO</div>
            <div id="jackpot-msg">大当り!</div>
        </div>

        <div id="handle-area" onmousedown="launchBall()">
            <div style="width:100%; height:10px; background:#f00; position:absolute; top:45%; transform:rotate(45deg);"></div>
        </div>
        <div id="handle-text">按空白鍵或點擊</div>
    </div>

    <script>
        // 替換為您的 CSV 連結 (請記得使用下面第二部分生成的資料)
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO5nwKqK0iYAzeMKhQgUHEN3FSrcMDzYxgclXwAu5dAH0Bcx_lBd9_olSw8JTT_s354u1i_rqonZwF/pub?output=csv';

        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Body = Matter.Body,
              Vector = Matter.Vector;

        const engine = Engine.create();
        const world = engine.world;
        engine.gravity.y = 1.0; // 標準重力

        // 尺寸定義
        const width = 480;
        const height = 700;

        const render = Render.create({
            element: document.getElementById('game-area'),
            engine: engine,
            options: {
                width: width, height: height,
                wireframes: false, background: 'transparent'
            }
        });

        // --- 1. 建立機台結構 (牆壁與軌道) ---
        // 這是帕青哥最關鍵的 "發射軌道"
        const walls = [
            // 左外牆
            Bodies.rectangle(0, height/2, 20, height, { isStatic: true, render: {fillStyle: '#444'} }),
            // 右外牆
            Bodies.rectangle(width, height/2, 20, height, { isStatic: true, render: {fillStyle: '#444'} }),
            // 底部
            Bodies.rectangle(width/2, height + 50, width, 100, { isStatic: true, label: 'floor' }),
            
            // **發射軌道 (Shooter Lane)** - 圓弧形頂部
            // 為了簡化，我們用多個矩形拼湊一個左上角的弧度
            Bodies.rectangle(30, 100, 10, 200, { isStatic: true, angle: -0.2, render: {fillStyle: 'silver'} }),
            Bodies.rectangle(80, 40, 150, 10, { isStatic: true, angle: 0.2, render: {fillStyle: 'silver'} }),
        ];
        Composite.add(world, walls);

        // --- 2. 讀取釘子資料 ---
        function loadLevel() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    const elements = [];
                    results.data.forEach(row => {
                        if (row.x && row.y) {
                            const size = row.size || 5;
                            
                            // 判斷類型
                            if (size >= 30) {
                                // --- 入賞口 (Tulip / Pocket) ---
                                // 建立感應區 (Sensor)
                                const pocket = Bodies.circle(row.x, row.y, size/2, {
                                    isStatic: true, isSensor: true, label: 'pocket',
                                    render: { fillStyle: 'rgba(255, 0, 85, 0.7)', strokeStyle: '#fff', lineWidth: 2 }
                                });
                                // 底部托盤圖形
                                const tray = Bodies.trapezoid(row.x, row.y + 10, size, size/2, 0.5, {
                                    isStatic: true, isSensor: true, render: { fillStyle: '#f1c40f' }
                                });
                                elements.push(pocket, tray);
                            } else {
                                // --- 普通釘子 (Brass Nail) ---
                                elements.push(Bodies.circle(row.x, row.y, 3, { // 釘子很細
                                    isStatic: true, label: 'nail',
                                    render: { fillStyle: '#eebb44' }, // 黃銅色
                                    restitution: 0.6 // 釘子稍微吸能
                                }));
                            }
                        }
                    });
                    Composite.add(world, elements);
                }
            });
        }

        // --- 3. 發射邏輯 (模擬手把) ---
        window.launchBall = function() {
            // 球從右下角生成
            const ball = Bodies.circle(440, 650, 5.5, { // 11mm 鋼珠
                label: 'ball',
                restitution: 0.7, friction: 0.001,
                render: { fillStyle: '#ecf0f1', strokeStyle: '#999', lineWidth: 1 }
            });

            Composite.add(world, ball);

            // 施加一個向左上方的瞬間力道 (模擬彈簧撞擊)
            // 力道稍微隨機，模擬真實機台的不穩定性
            const power = 0.038 + Math.random() * 0.004; 
            Body.applyForce(ball, ball.position, { x: -power * 0.7, y: -power });
        };

        // --- 4. 遊戲事件 ---
        let score = 0;
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(pair => {
                const bodyA = pair.bodyA, bodyB = pair.bodyB;
                // 檢查是否進洞
                if ((bodyA.label === 'ball' && bodyB.label === 'pocket') || 
                    (bodyB.label === 'ball' && bodyA.label === 'pocket')) {
                    
                    const ball = bodyA.label === 'ball' ? bodyA : bodyB;
                    triggerJackpot(ball);
                }
                // 檢查是否掉出底部
                if (bodyA.label === 'floor' || bodyB.label === 'floor') {
                    const ball = bodyA.label === 'ball' ? bodyA : bodyB;
                    Composite.remove(world, ball);
                }
            });
        });

        function triggerJackpot(ball) {
            Composite.remove(world, ball);
            score += 150; // 15R
            document.getElementById('ui-score').innerText = score;
            
            // 特效
            const msg = document.getElementById('jackpot-msg');
            msg.classList.add('active');
            setTimeout(() => msg.classList.remove('active'), 1000);
            
            // 螢幕閃爍
            const screen = document.getElementById('lcd-screen');
            screen.style.background = '#fff';
            screen.style.color = '#f00';
            screen.innerHTML = "777<br>FEVER!!";
            setTimeout(() => {
                screen.style.background = '#000';
                screen.style.color = '#fff';
                screen.innerHTML = "GOGO!<br>PACHINKO";
            }, 2000);
        }

        // --- 啟動 ---
        loadLevel();
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // **修正空白鍵**
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); // 禁止滾動
                launchBall();
                // 讓手把動一下
                document.getElementById('handle-area').style.transform = 'rotate(15deg)';
                setTimeout(() => document.getElementById('handle-area').style.transform = 'rotate(0deg)', 100);
            }
        });
    </script>
</body>
</html>
