<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REAL POWER PACHINKO</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');

        body {
            margin: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
        }

        #machine-container {
            position: relative;
            width: 520px;
            height: 850px;
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            border-radius: 40px;
            padding: 20px;
            box-shadow: 
                0 0 0 5px #333,
                0 0 0 10px #d4af37,
                0 0 60px rgba(212, 175, 55, 0.4),
                inset 0 0 100px rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            z-index: 1;
        }

        #game-canvas-wrapper {
            position: relative;
            width: 480px;
            height: 750px;
            background: #050505;
            border: 2px solid #d4af37;
            /* 右下角切角給發射器，並留出右側通道空間 */
            border-radius: 20px 20px 80px 20px;
            box-shadow: inset 0 0 40px rgba(212, 175, 55, 0.2);
            overflow: hidden;
        }
        
        .bg-grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(212, 175, 55, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 175, 55, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
            opacity: 0.5;
        }

        #ui-layer {
            position: absolute;
            top: 30px; left: 0; width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        .neon-text {
            color: #fff;
            font-size: 50px;
            text-shadow: 0 0 20px #d4af37, 0 0 40px #d4af37;
            letter-spacing: 5px;
        }

        #jackpot-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            text-align: center;
            z-index: 100;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        #jackpot-overlay.active { transform: translate(-50%, -50%) scale(1); }
        .fever-text {
            font-size: 80px; color: #ff00de;
            text-shadow: 0 0 30px rgba(255, 0, 222, 0.8);
            animation: shake 0.5s infinite;
        }

        #knob-container {
            position: absolute;
            bottom: 40px; right: 40px;
            width: 90px; height: 90px;
            border-radius: 50%;
            background: radial-gradient(circle, #222, #000);
            border: 4px solid #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            cursor: pointer;
            z-index: 20;
            transition: 0.1s;
        }
        #knob-container:active { transform: scale(0.95); }
        .knob-indicator {
            position: absolute; top: 10%; left: 45%; width: 10%; height: 40%;
            background: #d4af37; border-radius: 5px;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

    <div id="machine-container">
        <div id="game-canvas-wrapper">
            <div class="bg-grid"></div>
            <div id="ui-layer">
                <div class="neon-text" id="score">0000</div>
            </div>
            <div id="jackpot-overlay">
                <div class="fever-text">JACKPOT</div>
            </div>
        </div>
        
        <div id="knob-container" onmousedown="startFiring()" onmouseup="stopFiring()" onmouseleave="stopFiring()">
            <div class="knob-indicator"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO5nwKqK0iYAzeMKhQgUHEN3FSrcMDzYxgclXwAu5dAH0Bcx_lBd9_olSw8JTT_s354u1i_rqonZwF/pub?output=csv';

        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body, Vector = Matter.Vector;

        const engine = Engine.create();
        const world = engine.world;
        
        // --- 物理修正重點 1: 重力回歸 ---
        // 把重力調回接近正常，讓下落更有速度感
        engine.gravity.y = 1.1; 
        
        const width = 480;
        const height = 750;

        const render = Render.create({
            element: document.getElementById('game-canvas-wrapper'),
            engine: engine,
            options: { width, height, wireframes: false, background: 'transparent', pixelRatio: 2 }
        });

        // --- 特效系統 (保持不變) ---
        let particles = [];
        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                    life: 1.0, color: color || '#d4af37', size: Math.random() * 4 + 2
                });
            }
        }
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            ctx.globalCompositeOperation = 'lighter';
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fill();
                p.x += p.vx; p.y += p.vy; p.life -= 0.05; p.size *= 0.9;
                if (p.life <= 0) particles.splice(i, 1);
            }
            const bodies = Composite.allBodies(world);
            bodies.forEach(body => {
                if (body.label === 'ball' && body.speed > 2) { // 速度快才顯示拖尾
                    ctx.beginPath(); ctx.moveTo(body.position.x, body.position.y);
                    ctx.lineTo(body.position.x - body.velocity.x * 2, body.position.y - body.velocity.y * 2);
                    ctx.lineWidth = body.circleRadius; ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineCap = 'round'; ctx.stroke();
                    ctx.shadowBlur = 15; ctx.shadowColor = '#00ffff';
                }
                if (body.label === 'nail') {
                     ctx.shadowBlur = 8; ctx.shadowColor = '#d4af37';
                     ctx.fillStyle = '#fff8e7'; ctx.beginPath(); ctx.arc(body.position.x, body.position.y, 2.5, 0, Math.PI*2); ctx.fill();
                }
                if (body.label === 'pocket' || body.label === 'wall-glow') {
                     ctx.shadowBlur = 20; ctx.shadowColor = body.render.strokeStyle || '#d4af37';
                }
            });
            ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        });

        // --- 結構修正重點 2: 重建發射軌道 ---
        const wallStyle = { isStatic: true, render: { fillStyle: '#111', strokeStyle: '#d4af37', lineWidth: 2 }, label: 'wall-glow' };
        const invisibleWall = { isStatic: true, render: { visible: false } };

        const walls = [
            // 左邊界
            Bodies.rectangle(10, height/2, 20, height, wallStyle),
            // 底部
            Bodies.rectangle(width/2, height + 50, width, 100, invisibleWall),
            
            // **關鍵修正：右側發射通道**
            // 內部隔板 (將遊戲區與發射區隔開) - 位置在 x=440
            Bodies.rectangle(440, height/2 + 50, 10, height-100, wallStyle),
            // 最右側外牆 (隱形，防止球飛出去)
            Bodies.rectangle(width, height/2, 20, height, invisibleWall),

            // **關鍵修正：頂部導流彎道**
            // 移除舊的怪異直線，改成一個在右上角把球導向左邊的斜板
            Bodies.rectangle(420, 40, 150, 10, { 
                isStatic: true, 
                angle: 0.4, // 傾斜角度
                render: { fillStyle: '#111', strokeStyle: '#d4af37', lineWidth: 2 },
                label: 'wall-glow'
            })
        ];
        Composite.add(world, walls);

        // 讀取 CSV (保持不變)
        function loadLevel() {
            Papa.parse(CSV_URL, {
                download: true, header: true, dynamicTyping: true,
                complete: function(results) {
                    const elements = [];
                    results.data.forEach(row => {
                        if (row.x && row.y) {
                            const size = row.size || 5;
                            if (size >= 30) {
                                elements.push(Bodies.circle(row.x, row.y, size/2, {
                                    isStatic: true, isSensor: true, label: 'pocket',
                                    render: { fillStyle: 'transparent', strokeStyle: '#ff0055', lineWidth: 4 }
                                }));
                            } else {
                                elements.push(Bodies.circle(row.x, row.y, 3, { 
                                    isStatic: true, label: 'nail', restitution: 0.5, render: { visible: false } 
                                }));
                            }
                        }
                    });
                    Composite.add(world, elements);
                }
            });
        }

        // --- 物理修正重點 3: 發射力量 ---
        let fireInterval = null;
        function fireBall() {
            // 發射點改到右側通道內 (x=465)
            const ball = Bodies.circle(465, 700, 6, { 
                label: 'ball',
                frictionAir: 0.015,  // 大幅降低空氣阻力，讓球飛得快
                restitution: 0.5,
                density: 0.08,       // 增加密度，更有重量感
                render: { fillStyle: '#fff' } 
            });
            Composite.add(world, ball);

            // **大幅增加向上衝擊力**
            // 力道向量：x 稍微向左壓，y 強力向上
            const baseForceY = -0.18; // 這個數值控制向上的力量，越大越猛
            const baseForceX = -0.05; // 給一點點向左的力，讓它貼著軌道
            const randomVariation = (Math.random() - 0.5) * 0.02;
            
            Body.applyForce(ball, ball.position, { 
                x: baseForceX + randomVariation, 
                y: baseForceY + randomVariation 
            });

            createExplosion(465, 700, '#00ffff');
        }

        window.startFiring = function() {
            if(fireInterval) return;
            fireBall();
            fireInterval = setInterval(fireBall, 500); // 發射頻率
            document.getElementById('knob-container').style.transform = 'rotate(20deg) scale(0.95)';
        }

        window.stopFiring = function() {
            clearInterval(fireInterval); fireInterval = null;
            document.getElementById('knob-container').style.transform = 'rotate(0deg) scale(1)';
        }
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') startFiring(); });
        window.addEventListener('keyup', (e) => { if(e.code === 'Space') stopFiring(); });

        // 碰撞處理 (保持不變)
        let score = 0;
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if ((bodyA.label === 'ball' && bodyB.label === 'nail') || (bodyB.label === 'ball' && bodyA.label === 'nail')) {
                    createExplosion(pair.contacts[0].vertex.x, pair.contacts[0].vertex.y, '#ffd700');
                }
                if ((bodyA.label === 'ball' && bodyB.label === 'pocket') || (bodyB.label === 'ball' && bodyA.label === 'pocket')) {
                    triggerJackpot(bodyA.label === 'ball' ? bodyA : bodyB, bodyA.label === 'pocket' ? bodyA : bodyB);
                }
                if (bodyA.label === 'floor' || bodyB.label === 'floor') {
                    Composite.remove(world, bodyA.label === 'ball' ? bodyA : bodyB);
                }
            });
        });

        function triggerJackpot(ball, pocket) {
            Composite.remove(world, ball); score += 150;
            document.getElementById('score').innerText = score.toString().padStart(4, '0');
            createExplosion(pocket.position.x, pocket.position.y, '#ff0055');
            document.getElementById('jackpot-overlay').classList.add('active');
            setTimeout(() => document.getElementById('jackpot-overlay').classList.remove('active'), 1000);
        }

        loadLevel(); Render.run(render); Runner.run(Runner.create(), engine);
    </script>
</body>
</html>
